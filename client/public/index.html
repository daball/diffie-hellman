<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Diffie-Hellman Chat Client</title>
    <link rel="stylesheet" type="text/css" href="/lib/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="/lib/bootstrap/dist/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="/lib/font-awesome/css/font-awesome.css" />
    <style>
    body { padding-top: 50pt; padding-bottom: 55pt; }
    #chat,#message { font-family: 'Ubuntu Mono', monospace; }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">
             <i class="fa fa-wechat"></i> <span id="nick"></span> Diffie-Hellman Chat Client
          </a>
        </div>
      </div>
    </nav>

    <div id="chat" class="container-fluid"><b>Diffie-Hellman Chat Client</b><br /><b>(c) 2016 David Ball.</b><br /></div>

    <nav class="navbar navbar-inverse navbar-fixed-bottom">
        <form class="navbar-form navbar-left" role="search" onsubmit="return false">
          <div style="display:table;" class="form-group input-group">
            <textarea class="form-control" name="message" id="message" autofocus="autofocus" autocomplete="off" placeholder="Send a public chat..."></textarea>
            <span style="width: 1%;" class="input-group-addon"><button id="send" type="submit" class="btn btn-default"><i class="fa fa-paper-plane" aria-hidden="true"></i></button></span>
          </div>
        </form>
      </div>
    </nav>

    <script type="text/javascript" src="/lib/jquery/dist/jquery.js"></script>
    <script type="text/javascript" src="/lib/bootstrap/dist/js/bootstrap.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
    function bold(html) { return "<b>" + html + "</b>"; }
    var br = "<br />";
    function formatMessage(nick, message) {
      return bold(nick) + bold("&gt;") + " " + message;
    }

    //connects web browser chat client on the server
    var socket;
    var nick = '';


    function setNick(newNick) {
      nick = newNick;
      $('#nick').text(nick + ' - ');
      document.title = nick + ' - Diffie-Hellman Chat Client';
    }

    //accepts input
    function send(msg) {
      if (msg)
        socket.emit('chat', msg);
    }

    function receive(chat) {
      var search = /^<b>SYSTEM<\/b><b>&gt;<\/b> Your nickname is (.*)\.<br \/>/;
      var matches = chat.match(search);
      if (matches) {
        var newNick = matches[1];
        setNick(newNick);
      }
      if ($('#chat').html().trim().lastIndexOf('<br') < $('#chat').html().trim().length-4) {
        chat = br + chat;
      }
      $('#chat').html($('#chat').html() + chat);
      $('html,body').animate({scrollTop: document.body.scrollHeight},"fast");
    }

    //send button on click
    $('#send').click(function () {
      send($('#message').val());
      $('#message').val('');
    });

    function connect() {
      //display connecting...
      $('#chat').html($('#chat').html() + br + formatMessage('BROWSER', "Connecting to chat client..."));
      socket = io.connect();
    }

    //listen for enter
    $('#message').keydown(function(evt) {
      //console.log(evt);
        if (event.keyCode == 13) {
            $('#send').click();
            return false;
         }
    });
    connect();
    socket.on("connect", function () {
        console.log("Connected!");
        $('#chat').html($('#chat').html() + br + formatMessage('BROWSER', "Connected to chat client..."));
        socket.on("chat", receive);
    });
    </script>
  </body>
</html>
